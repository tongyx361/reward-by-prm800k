nohup: ignoring input
[2023-09-10 01:34:42,541] [INFO] [real_accelerator.py:133:get_accelerator] Setting ds_accelerator to cuda (auto detect)
[2023-09-10 01:34:43,833] [WARNING] [runner.py:196:fetch_hostfile] Unable to find hostfile, will proceed with training with local resources only.
[2023-09-10 01:34:43,834] [INFO] [runner.py:555:main] cmd = /data/users/zhangjunlei/anaconda3/envs/open-instruct/bin/python -u -m deepspeed.launcher.launch --world_info=eyJsb2NhbGhvc3QiOiBbMSwgMywgNCwgNl19 --master_addr=127.0.0.1 --master_port=29500 --enable_each_rank_log=None /data/users/zhangjunlei/tyx/FastChat/fastchat/train/train_qlora_flash_attn_2.py --model_name_or_path /data/users/zhangjunlei/tyx/.cache/huggingface/hub/models--meta-llama--Llama-2-7b-hf/snapshots/6fdf2e60f86ff2481f2241aaee459f85b5b0bbb9 --encoded_datasets_path /data/users/zhangjunlei/tyx/reward-by-prm800k/datasets/prm800k-train-direct-prediction-0-02validiation-encoded-datasets --output_dir /data/users/zhangjunlei/tyx/reward-by-prm800k/models/llama2-7b-qlora-prm800k-train-direct-prediction-0-02validiation-bs=128-gas=16 --model_max_length 1024 --per_device_train_batch_size 2 --per_device_eval_batch_size 4 --gradient_checkpointing True --gradient_accumulation_steps 16 --num_train_epochs 100 --evaluation_strategy steps --eval_steps 100 --eval_first False --save_strategy steps --save_steps 100 --load_best_model_at_end True --metric_for_best_model f1_-1 --greater_is_better True --learning_rate 2e-5 --weight_decay 0. --warmup_ratio 0.03 --lr_scheduler_type linear --lora_r 16 --lora_alpha 16 --lora_dropout 0.05 --lora_target_modules all_linear --q_lora True --bf16 True --tf32 True --use_accelerate_lib flash-attn-v2 --deepspeed /data/users/zhangjunlei/tyx/reward-by-prm800k/ds_configs/stage0.conf --logging_strategy steps --logging_steps 1 --custom_debug True
[2023-09-10 01:34:45,313] [INFO] [real_accelerator.py:133:get_accelerator] Setting ds_accelerator to cuda (auto detect)
[2023-09-10 01:34:47,817] [INFO] [launch.py:145:main] WORLD INFO DICT: {'localhost': [1, 3, 4, 6]}
[2023-09-10 01:34:47,817] [INFO] [launch.py:151:main] nnodes=1, num_local_procs=4, node_rank=0
[2023-09-10 01:34:47,817] [INFO] [launch.py:162:main] global_rank_mapping=defaultdict(<class 'list'>, {'localhost': [0, 1, 2, 3]})
[2023-09-10 01:34:47,817] [INFO] [launch.py:163:main] dist_world_size=4
[2023-09-10 01:34:47,817] [INFO] [launch.py:165:main] Setting CUDA_VISIBLE_DEVICES=1,3,4,6
[2023-09-10 01:34:51,390] [INFO] [real_accelerator.py:133:get_accelerator] Setting ds_accelerator to cuda (auto detect)
[2023-09-10 01:34:51,456] [INFO] [real_accelerator.py:133:get_accelerator] Setting ds_accelerator to cuda (auto detect)
[2023-09-10 01:34:51,468] [INFO] [real_accelerator.py:133:get_accelerator] Setting ds_accelerator to cuda (auto detect)
[2023-09-10 01:34:51,476] [INFO] [real_accelerator.py:133:get_accelerator] Setting ds_accelerator to cuda (auto detect)
[2023-09-10 01:34:53,420] [WARNING] [comm.py:152:init_deepspeed_backend] NCCL backend in DeepSpeed not yet implemented
[2023-09-10 01:34:53,420] [INFO] [comm.py:616:init_distributed] cdb=None
[2023-09-10 01:34:53,420] [WARNING] [comm.py:152:init_deepspeed_backend] NCCL backend in DeepSpeed not yet implemented
[2023-09-10 01:34:53,420] [INFO] [comm.py:616:init_distributed] cdb=None
[2023-09-10 01:34:53,445] [WARNING] [comm.py:152:init_deepspeed_backend] NCCL backend in DeepSpeed not yet implemented
[2023-09-10 01:34:53,445] [INFO] [comm.py:616:init_distributed] cdb=None
[2023-09-10 01:34:53,484] [WARNING] [comm.py:152:init_deepspeed_backend] NCCL backend in DeepSpeed not yet implemented
[2023-09-10 01:34:53,485] [INFO] [comm.py:616:init_distributed] cdb=None
[2023-09-10 01:34:53,485] [INFO] [comm.py:643:init_distributed] Initializing TorchBackend in DeepSpeed with backend nccl
Loading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]Sun Sep 10 01:34:54 2023       
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 515.48.07    Driver Version: 515.48.07    CUDA Version: 11.7     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================+======================+======================|
|   0  NVIDIA A100-SXM...  On   | 00000000:12:00.0 Off |                    0 |
| N/A   32C    P0    69W / 400W |   1114MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   1  NVIDIA A100-SXM...  On   | 00000000:18:00.0 Off |                    0 |
| N/A   30C    P0    64W / 400W |      2MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   2  NVIDIA A100-SXM...  On   | 00000000:4A:00.0 Off |                    0 |
| N/A   31C    P0    73W / 400W |  42836MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   3  NVIDIA A100-SXM...  On   | 00000000:4E:00.0 Off |                    0 |
| N/A   30C    P0    64W / 400W |      2MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   4  NVIDIA A100-SXM...  On   | 00000000:8A:00.0 Off |                    0 |
| N/A   34C    P0    73W / 400W |      2MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   5  NVIDIA A100-SXM...  On   | 00000000:8F:00.0 Off |                    0 |
| N/A   35C    P0    82W / 400W |   2785MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   6  NVIDIA A100-SXM...  On   | 00000000:C6:00.0 Off |                    0 |
| N/A   33C    P0    72W / 400W |      2MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   7  NVIDIA A100-SXM...  On   | 00000000:CA:00.0 Off |                    0 |
| N/A   35C    P0    84W / 400W |  23751MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
                                                                               
+-----------------------------------------------------------------------------+
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
|    0   N/A  N/A    242938      C   python3                           555MiB |
|    0   N/A  N/A   2724011      C   python3                           555MiB |
|    2   N/A  N/A    187985      C   python                          37871MiB |
|    2   N/A  N/A    242938      C   python3                          4963MiB |
|    5   N/A  N/A   2724011      C   python3                          2783MiB |
|    7   N/A  N/A   1004856      C   python                          23747MiB |
+-----------------------------------------------------------------------------+

Loading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]Loading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]Loading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]Loading checkpoint shards:  50%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     | 1/2 [00:07<00:07,  7.35s/it]Loading checkpoint shards:  50%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     | 1/2 [00:11<00:11, 12.00s/it]Loading checkpoint shards:  50%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     | 1/2 [00:07<00:07,  7.91s/it]Loading checkpoint shards:  50%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     | 1/2 [00:08<00:08,  8.02s/it]Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:10<00:00,  4.81s/it]Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:10<00:00,  5.19s/it]
Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:14<00:00,  6.51s/it]Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:14<00:00,  7.33s/it]
Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:10<00:00,  4.84s/it]Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:10<00:00,  5.31s/it]
Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:10<00:00,  4.84s/it]Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:10<00:00,  5.30s/it]
Sun Sep 10 01:35:15 2023       
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 515.48.07    Driver Version: 515.48.07    CUDA Version: 11.7     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================+======================+======================|
|   0  NVIDIA A100-SXM...  On   | 00000000:12:00.0 Off |                    0 |
| N/A   32C    P0    73W / 400W |   1114MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   1  NVIDIA A100-SXM...  On   | 00000000:18:00.0 Off |                    0 |
| N/A   31C    P0    81W / 400W |   4457MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   2  NVIDIA A100-SXM...  On   | 00000000:4A:00.0 Off |                    0 |
| N/A   31C    P0    75W / 400W |  42836MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   3  NVIDIA A100-SXM...  On   | 00000000:4E:00.0 Off |                    0 |
| N/A   30C    P0    68W / 400W |   4457MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   4  NVIDIA A100-SXM...  On   | 00000000:8A:00.0 Off |                    0 |
| N/A   35C    P0    80W / 400W |   4457MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   5  NVIDIA A100-SXM...  On   | 00000000:8F:00.0 Off |                    0 |
| N/A   34C    P0    72W / 400W |   2785MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   6  NVIDIA A100-SXM...  On   | 00000000:C6:00.0 Off |                    0 |
| N/A   33C    P0    87W / 400W |   5459MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   7  NVIDIA A100-SXM...  On   | 00000000:CA:00.0 Off |                    0 |
| N/A   34C    P0    74W / 400W |  23751MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
                                                                               
+-----------------------------------------------------------------------------+
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
|    0   N/A  N/A    242938      C   python3                           555MiB |
|    0   N/A  N/A   2724011      C   python3                           555MiB |
|    1   N/A  N/A   2233924      C   .../open-instruct/bin/python     4455MiB |
|    2   N/A  N/A    187985      C   python                          37871MiB |
|    2   N/A  N/A    242938      C   python3                          4963MiB |
|    3   N/A  N/A   2233925      C   .../open-instruct/bin/python     5457MiB |
|    4   N/A  N/A   2233926      C   .../open-instruct/bin/python     4455MiB |
|    5   N/A  N/A   2724011      C   python3                          2783MiB |
|    6   N/A  N/A   2233927      C   .../open-instruct/bin/python     5465MiB |
|    7   N/A  N/A   1004856      C   python                          23747MiB |
+-----------------------------------------------------------------------------+

get_peft_model() took 39.67857837677002 s
Sun Sep 10 01:36:01 2023       
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 515.48.07    Driver Version: 515.48.07    CUDA Version: 11.7     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================+======================+======================|
|   0  NVIDIA A100-SXM...  On   | 00000000:12:00.0 Off |                    0 |
| N/A   32C    P0    69W / 400W |   1114MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   1  NVIDIA A100-SXM...  On   | 00000000:18:00.0 Off |                    0 |
| N/A   32C    P0    86W / 400W |   5617MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   2  NVIDIA A100-SXM...  On   | 00000000:4A:00.0 Off |                    0 |
| N/A   31C    P0    74W / 400W |  42836MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   3  NVIDIA A100-SXM...  On   | 00000000:4E:00.0 Off |                    0 |
| N/A   30C    P0    68W / 400W |   5617MiB / 81920MiB |      1%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   4  NVIDIA A100-SXM...  On   | 00000000:8A:00.0 Off |                    0 |
| N/A   35C    P0    75W / 400W |   5617MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   5  NVIDIA A100-SXM...  On   | 00000000:8F:00.0 Off |                    0 |
| N/A   35C    P0    82W / 400W |   2785MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   6  NVIDIA A100-SXM...  On   | 00000000:C6:00.0 Off |                    0 |
| N/A   33C    P0    74W / 400W |   4617MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   7  NVIDIA A100-SXM...  On   | 00000000:CA:00.0 Off |                    0 |
| N/A   35C    P0    89W / 400W |  23751MiB / 81920MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
                                                                               
+-----------------------------------------------------------------------------+
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
|    0   N/A  N/A    242938      C   python3                           555MiB |
|    0   N/A  N/A   2724011      C   python3                           555MiB |
|    1   N/A  N/A   2233924      C   .../open-instruct/bin/python     5615MiB |
|    2   N/A  N/A    187985      C   python                          37871MiB |
|    2   N/A  N/A    242938      C   python3                          4963MiB |
|    3   N/A  N/A   2233925      C   .../open-instruct/bin/python     4615MiB |
|    4   N/A  N/A   2233926      C   .../open-instruct/bin/python     5615MiB |
|    5   N/A  N/A   2724011      C   python3                          2783MiB |
|    6   N/A  N/A   2233927      C   .../open-instruct/bin/python     4615MiB |
|    7   N/A  N/A   1004856      C   python                          23747MiB |
+-----------------------------------------------------------------------------+

trainable params: 39,976,960 || all params: 6,778,392,576 || trainable%: 0.589770503135875
wandb: Currently logged in as: kidrain61. Use `wandb login --relogin` to force relogin
wandb: - Waiting for wandb.init()...wandb: \ Waiting for wandb.init()...wandb: Tracking run with wandb version 0.15.10
wandb: Run data is saved locally in /data/users/zhangjunlei/tyx/wandb/wandb/run-20230910_013611-zy3x3iwv
wandb: Run `wandb offline` to turn off syncing.
wandb: Syncing run 2023-09-09-2-llama2-7b-qlora-prm800k-train-direct-prediction-0-02validiation-bs=128-gas=16
wandb: â­ï¸ View project at https://wandb.ai/kidrain61/step-reward
wandb: ðŸš€ View run at https://wandb.ai/kidrain61/step-reward/runs/zy3x3iwv
  0%|          | 0/66500 [00:00<?, ?it/s]  0%|          | 1/66500 [00:16<298:36:08, 16.17s/it]                                                     {'loss': 18.7359, 'learning_rate': 1.0025062656641605e-08, 'epoch': 0.0}
  0%|          | 1/66500 [00:16<298:36:08, 16.17s/it]  0%|          | 2/66500 [00:29<270:05:42, 14.62s/it]                                                     {'loss': 18.3576, 'learning_rate': 2.005012531328321e-08, 'epoch': 0.0}
  0%|          | 2/66500 [00:29<270:05:42, 14.62s/it]  0%|          | 3/66500 [00:43<260:57:49, 14.13s/it]                                                     {'loss': 18.8423, 'learning_rate': 3.0075187969924815e-08, 'epoch': 0.0}
  0%|          | 3/66500 [00:43<260:57:49, 14.13s/it]  0%|          | 4/66500 [00:56<256:41:06, 13.90s/it]                                                     {'loss': 18.4494, 'learning_rate': 4.010025062656642e-08, 'epoch': 0.01}
  0%|          | 4/66500 [00:56<256:41:06, 13.90s/it]